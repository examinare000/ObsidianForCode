# v0.4.7

## ✨ 新機能・改善

### WikiLink操作性の大幅改善（ADR-016）

v0.4.7では、WikiLinkの操作体験を向上させる3つの主要改善を実装しました。

#### 1. キーバインド境界検出の拡張

- **問題**: WikiLinkの閉じ括弧 `]]` 上では `Ctrl/Cmd+Enter` が動作しなかった
- **解決**: `obsd.inWikiLink` コンテキストが `]]` の2文字目まで範囲に含まれるように拡張
- **効果**: WikiLinkの任意の位置でキーバインドが確実に発火

#### 2. リンク解決精度の向上

- **問題**: サブディレクトリ内の既存ノートにジャンプできなかった
- **解決**: `WikiLinkDocumentLinkProvider` を非同期化し、`NoteFinder` 統合で既存ノートURIを優先解決
- **効果**: `obsd.searchSubdirectories` が有効な場合、サブディレクトリ内のノートへ正確にジャンプ

#### 3. WikiLink補完の安定化

- **問題**: `[[Page#Heading]]` や `[[Page|Alias]]` 入力中に補完が停止またはエラーが発生
- **解決**:
  - `#` と `|` をセクション区切りとして検出し、WikiLink本体のみをプレフィックス検索対象に
  - 別名セクションでは補完を停止
  - 置換レンジを区切り文字直前までに限定して誤上書きを防止
- **効果**: Heading/Alias付きWikiLinkでも安定した補完候補提示

## 📊 テスト品質

- **テスト数**: 231個
- **成功**: 221個（95.7%）
- **スキップ**: 10個（意図的）
- **新規追加**: 6件の境界ケーステスト

## 🔧 技術的詳細

### 変更されたコンポーネント

1. **WikiLinkContextProvider** (`src/providers/WikiLinkContextProvider.ts:113`)
   - 境界検出ロジックを `offset <= linkEnd - 1` に変更

2. **CommandHandler** (`src/commands/CommandHandler.ts:208-227`)
   - `getWikiLinkAtPosition` メソッドの境界検出改善
   - `lastIndexOf`/`indexOf` の組み合わせでオフセット検証を追加

3. **WikiLinkDocumentLinkProvider** (`src/providers/WikiLinkDocumentLinkProvider.ts:49`)
   - `provideDocumentLinks` を非同期化（`Promise<DocumentLink[]>`）
   - `resolveLinkTarget` フック追加で既存ノート優先解決

4. **WikiLinkCompletionProvider** (`src/providers/WikiLinkCompletionProvider.ts:68-110`)
   - `#`/`|` 区切り文字対応のプレフィックス抽出
   - 別名セクションでの補完停止ロジック
   - 置換レンジ制御の改善

5. **extension.ts** (`src/extension.ts:243-290, 483-502`)
   - 上記変更の実装側統合

6. **vscode-test-types.ts** (`src/types/vscode-test-types.ts:69`)
   - `DocumentLinkProvider` 型定義を非同期対応

### アーキテクチャ決定記録

詳細は [ADR-016: WikiLink Interaction Refinement](../adr/016-wikilink-interaction-refinement.md) を参照。

## 🔗 関連情報

- 前バージョン: [v0.4.6](./v0.4.6.md)
- リリース日: 2025-10-07
- ADR: [016-wikilink-interaction-refinement.md](../adr/016-wikilink-interaction-refinement.md)
