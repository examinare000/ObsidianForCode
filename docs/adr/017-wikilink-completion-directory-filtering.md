# ADR-017: WikiLink Completion Directory Filtering

## ステータス
採用 (Accepted)

## 日付
2025-10-08

## 文脈

ObsidianForCode の WikiLink 補完機能は、Vault 内の全ディレクトリを対象としてファイル名によるマッチングを行っていた。これは小規模な Vault では問題なく動作するが、以下の課題があった。

1. **大規模 Vault での補完候補の氾濫**
   サブディレクトリが多い大規模 Vault では、同じファイル名が複数のディレクトリに存在する場合、補完候補が多すぎてユーザーが目的のファイルを見つけにくい。

2. **ディレクトリ構造を活用した絞り込みができない**
   Obsidian では `folder/file` のような記法でディレクトリを指定してファイルを絞り込むことができるが、この機能が実装されていなかった。

3. **補完のトリガータイミングの不足**
   `[[` の入力時のみ補完がトリガーされるため、ディレクトリパスを入力中に補完が自動的に再トリガーされない。

## 決定

以下の変更を実装した：

### 1. NoteFinder のディレクトリパス解析機能追加

`NoteFinder.findNotesByPrefix()` メソッドにディレクトリパス解析機能を追加：
- `prefix` パラメータに含まれるスラッシュ (`/`) を検出
- 最後のスラッシュを境にディレクトリパスとファイル名プレフィックスに分離
- ディレクトリパスが指定されている場合、そのディレクトリ内のみを検索
- ファイル名プレフィックスでファイル名をマッチング

```typescript
// 例: "projects/Project" の場合
// directoryPath = "projects"
// filePrefix = "Project"
const lastSlashIndex = prefix.lastIndexOf('/');
const directoryPath = lastSlashIndex >= 0 ? prefix.substring(0, lastSlashIndex) : '';
const filePrefix = lastSlashIndex >= 0 ? prefix.substring(lastSlashIndex + 1) : prefix;
```

### 1.5. サブディレクトリ名前方一致検索機能の追加

ディレクトリパスが指定されていない場合、ディレクトリ名自体がプレフィックスにマッチするファイルも候補に含める：
- パス内の各ディレクトリセグメントをプレフィックスとマッチング
- ディレクトリ名がマッチした場合、そのディレクトリ内のすべてのファイルを候補に追加
- マッチタイプ（exact、filePrefix、dirPrefix）で優先順位を付与

```typescript
// 例: "proj" というプレフィックスで検索した場合
// - "Project.md" （ファイル名マッチ）
// - "projects/Plan.md" （ディレクトリ名 "projects" がマッチ）
// - "projects/Notes.md" （ディレクトリ名 "projects" がマッチ）
```

この機能により、ユーザーはディレクトリ名を入力するだけでそのディレクトリ内のファイルを探索できる。

### 2. スラッシュ記法のサポート

以下のパターンをサポート：
- `folder/file` - 特定ディレクトリ内のファイルを絞り込み
- `folder/` - ディレクトリ内の全ファイルをリスト
- `folder/subfolder/file` - ネストされたディレクトリパスをサポート
- `file` - 従来通り全ディレクトリを検索（後方互換性）

### 3. トリガー文字に `/` を追加

`vscode.languages.registerCompletionItemProvider` のトリガー文字に `'/'` を追加：
```typescript
vscode.languages.registerCompletionItemProvider(
    { scheme: 'file', language: 'markdown' },
    wikiLinkCompletionProvider,
    '[', // Trigger character for opening bracket
    '/'  // Trigger character for directory path separator
);
```

これにより、ディレクトリパスを入力中 (`[[folder/`) に自動的に補完がトリガーされる。

### 4. 包括的なテストケース追加

以下のテストケースを `tests/unit/NoteFinder.test.ts` に追加：
- ディレクトリパスを含むプレフィックスで絞り込み
- ディレクトリパスの末尾がスラッシュの場合の動作
- ネストされたディレクトリパスのサポート
- マッチするファイルがない場合の動作
- 後方互換性の維持

## 根拠

1. **ユーザビリティの向上**
   ディレクトリ構造を活用して補完候補を絞り込むことで、大規模 Vault でのファイル検索が効率化される。

2. **Obsidian との互換性**
   Obsidian の `folder/file` 記法をサポートすることで、Obsidian ユーザーが違和感なく使用できる。

3. **後方互換性の維持**
   スラッシュを含まない従来の補完動作を維持することで、既存ユーザーのワークフローに影響を与えない。

4. **UX の向上**
   トリガー文字 `/` の追加により、ディレクトリパス入力中に自動的に補完が再トリガーされ、スムーズな入力体験を提供。

5. **TDD による品質保証**
   包括的なテストケースにより、エッジケースや回帰を防止し、機能の信頼性を確保。

## 影響

### プラス
- 大規模 Vault での補完精度とユーザビリティが大幅に向上
- ディレクトリ構造を活用した効率的なファイル検索が可能
- 自動補完のトリガーによる入力体験の向上
- サブディレクトリ名前方一致により、ディレクトリ名を入力するだけでそのディレクトリ内のファイルを探索可能
- マッチタイプによる優先順位付けで、ユーザーの意図に沿った候補を優先表示
- 包括的なテストケースによる機能の品質保証
- Obsidian との互換性向上

### マイナス
- ディレクトリパス解析によるわずかな処理オーバーヘッド（実用上は無視できるレベル）
- 補完候補の計算ロジックがやや複雑化

### ニュートラル
- 後方互換性を維持しているため、既存ユーザーのワークフローに影響なし
- ディレクトリパスを使わないユーザーには従来通りの動作

## フォローアップ

- ディレクトリパス補完時のパフォーマンス監視（大規模 Vault での検証）
- マルチルートワークスペースでの動作検証
- ディレクトリパス自体の補完機能（現在はファイル名のみ補完）の検討
