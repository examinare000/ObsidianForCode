# ADR-016: WikiLink補完機能の強化

## Status
Accepted

## Date
2025-10-02

## Context
現状のWikiLink補完機能は`[`文字をトリガーとして自動的に候補を表示するが、以下の課題がある：

1. WikiLink括弧`[[]]`が閉じていない状態でも補完候補が表示され、ユーザーが意図しないタイミングで候補が出現する
2. 空のWikiLink`[[]]`に対しても補完が動作し、全ファイルが候補として表示されパフォーマンスに影響する
3. 手動で補完をトリガーする方法がなく、自動補完の挙動に依存せざるを得ない
4. サブフォルダ内のファイルが補完候補として正しく表示されないケースが報告されている

## Decision
WikiLink補完機能を以下の仕様に変更する：

### 1. 補完動作条件の厳格化
- **カーソル位置要件**: カーソルの右隣に`]]`が存在する場合のみ補完を提供
- **入力済み文字要件**: `[[`と`]]`の間に1文字以上の入力がある場合のみ補完を提供
- これにより、ユーザーが意図的にWikiLink を記述している状況でのみ補完が動作

### 2. 手動トリガーの追加
- `ctrl+'` (Mac: `cmd+'`) キーバインドで補完を手動トリガー可能にする
- 自動補完が動作しない場合でも、ユーザーが明示的に補完候補を呼び出せる

### 3. 前方一致検索の明確化
- 入力されたプレフィックスで前方一致検索を実行
- 既存の`NoteFinder.findNotesByPrefix`を活用
- 大文字小文字を区別しない検索を維持

### 4. サブフォルダ対応の保証
- `NoteFinder.findNotesByPrefix`がサブディレクトリを再帰的に検索することを保証
- 相対パス情報を補完候補の詳細情報として表示
- サブフォルダ内のファイルが正しく検出され、補完候補として提示されることをテストで保証

### 5. VSCode標準CompletionItemProviderの活用
- 既存の`WikiLinkCompletionProvider`を拡張
- VSCode標準の補完UI（矢印キー選択、Tab/Enter確定）を活用
- 一意に確定する候補はTabキーで即座に確定可能

## Implementation Details

### 修正箇所
1. `src/providers/WikiLinkCompletionProvider.ts`
   - `provideCompletionItems`メソッドに新しい条件チェックを追加
   - カーソル右に`]]`が存在するかチェック
   - プレフィックスが1文字以上あるかチェック

2. `package.json`
   - `ctrl+'`キーバインドを追加し、補完トリガーコマンドにマッピング

3. テスト
   - 新しい動作要件をカバーするテストケースを追加
   - サブフォルダ内ファイル検索のテストを強化

## Consequences

### Positive
- **ユーザー体験向上**: 意図しない補完候補表示が減少
- **パフォーマンス改善**: 空のWikiLinkでの全ファイル検索を回避
- **柔軟性向上**: 手動トリガーにより、ユーザーが補完タイミングを制御可能
- **正確性向上**: サブフォルダ内ファイルが正しく補完候補に表示される
- **VSCode標準UIの活用**: ユーザーが慣れ親しんだ補完UIを使用

### Negative
- **学習コスト**: 新しいキーバインド`ctrl+'`を覚える必要がある
- **挙動変更**: 既存ユーザーは補完が動作するタイミングの変更に適応が必要

### Neutral
- **互換性**: 既存の`NoteFinder`実装を再利用し、大きな設計変更は不要
- **テスト拡充**: 新しいテストケースにより、補完機能の品質が向上

## Notes
- Markdownリスト継続機能の廃止（ADR-017）と同時に実装
- `ctrl+'`キーバインドはVSCodeの標準的な補完トリガーパターンに準拠
- サブフォルダ対応は`NoteFinder`が既に実装済みの機能を明示的にテスト
